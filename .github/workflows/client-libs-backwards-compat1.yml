name: Client Libs Backward Compatibility - New

on:
  push:
    paths-ignore:
      - 'README.md'
      - .github/workflows/skills-service-backward-compat.yml
      - .github/workflows/client-libs-backward-compat.yml
  pull_request:
    paths-ignore:
      - 'README.md'
      - .github/workflows/skills-service-backward-compat.yml
      - .github/workflows/client-libs-backward-compat.yml
  workflow_dispatch:

jobs:
  get_skills_service_versions:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.generate-matrix.outputs.services }}
      versions: ${{ steps.generate-matrix.outputs.versions }}
    steps:
      - name: Generate Matrix
        id: generate-matrix
        run: |
          RESPONSE=$(curl -s -X GET 'https://api.github.com/repos/NationalSecurityAgency/skills-service/releases')
          TAG_NAMES=$(echo "$RESPONSE" | jq -c '[.[] | .tag_name] | .[:5]')
          echo "TAG_NAMES=$TAG_NAMES"
          echo ::set-output name=versions::${TAG_NAMES}

  run_backward_compatibility_tests:
    runs-on: ubuntu-latest
    needs:
      - get_skills_service_versions
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJSON(needs.get_skills_service_versions.outputs.versions) }}
    steps:
      - name: Matrix => (${{ matrix.version}})
        run: |
          echo ${{ matrix.version }}
